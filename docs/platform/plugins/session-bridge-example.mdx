---
id: session-bridge-example
title: SessionBridge 예제
description: BioStar X SessionBridge를 활용한 실제 구현 예제와 테스트 서버를 제공합니다.
keywords: [SessionBridge, 예제, 테스트 서버, 실습]
---

# SessionBridge 예제

BioStar X SessionBridge 기능을 실제로 구현하고 테스트할 수 있는 완전한 예제를 제공합니다. 이 예제를 통해 플러그인 개발의 전체 과정을 체험하고 이해할 수 있습니다.

## 예제 개요

이 예제는 BioStar X와 연동되는 플러그인의 핵심 기능인 SessionBridge를 구현한 테스트 서버입니다. 실제 운영 환경에서 사용할 수 있는 기능들을 포함하고 있어 플러그인 개발의 참고 자료로 활용할 수 있습니다.

### 주요 기능

- **RSA 암호화를 통한 보안 세션 생성**: RSA 공개키 암호화 및 AES-256 복호화
- **BioStar API 세션 관리**: 세션 생성, 저장, 조회 및 로그아웃
- **웹 기반 테스트 인터페이스**: 브라우저를 통한 API 테스트 도구  
- **RESTful API 프록시**: BioStar API를 웹서버를 통해 프록시

## 시스템 요구사항

### 소프트웨어 요구사항
- **Python 3.11+**: 최신 Python 버전 필요
- **uv**: Python 패키지 관리 도구
- **public_key.pem**: BioStar X Service Manager에서 다운로드한 공개키 파일

### 하드웨어 요구사항
- **메모리**: 최소 512MB RAM
- **디스크**: 최소 100MB 여유 공간
- **네트워크**: BioStar X 서버와 통신 가능한 네트워크 환경

## 설치 및 설정

### 1. uv 설치

Python 패키지 관리 도구인 uv를 설치합니다.

**Windows (PowerShell):**
```powershell
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**macOS/Linux:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

**pip를 통한 설치:**
```bash
pip install uv
```

### 2. 프로젝트 설정

```bash
# 예제 프로젝트 폴더로 이동
cd BioStarX-session-bridge/web

# 가상환경 생성 및 활성화
uv venv

# 의존성 패키지 설치
uv pip install -r requirements.txt
```

### 3. 공개키 파일 준비

BioStar X Service Manager에서 다운로드한 공개키 파일을 준비합니다.

1. **BioStar X Service Manager 접속**
2. **Plugins 페이지 이동**
3. **플러그인 상세 페이지에서 인증서 다운로드**
4. **다운로드된 파일을 `public_key.pem`으로 이름 변경**

```bash
# 공개키 파일 복사 (Windows)
copy ..\your_plugin_id_public_key.pem .\public_key.pem

# 공개키 파일 복사 (macOS/Linux)  
cp ../your_plugin_id_public_key.pem ./public_key.pem
```

### 4. 서버 설정

`config.py` 파일에서 BioStar X 서버 정보를 설정합니다:

```python
# BioStar X 서버 설정
SERVER_CONFIG = {
    "address": "192.168.1.2",     # BioStar X 서버 IP 주소
    "port": 443,                  # BioStar X 서버 포트 (HTTPS)
    "ssl_verify": False           # SSL 인증서 검증 여부 (개발환경: False)
}

# 웹서버 설정
WEB_CONFIG = {
    "host": "0.0.0.0",           # 바인딩할 IP 주소
    "port": 8000,                # 웹서버 포트
    "request_timeout": 60        # 요청 타임아웃 (초)
}

# 파일 경로 설정
FILE_CONFIG = {
    "public_key_path": "public_key.pem"  # RSA 공개키 파일 경로
}
```

## 서버 실행

### 간단한 실행 (권장)

```bash
uv run run_server.py
```

### 직접 uvicorn 실행

```bash
uv run uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

서버가 정상적으로 시작되면 다음 메시지가 표시됩니다:

```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [12345] using statreload
INFO:     Started server process [12346]
INFO:     Waiting for application startup.
```

## 사용 방법

### 1. 웹 인터페이스를 통한 테스트

1. **브라우저에서 접속**: `http://localhost:8000`
2. **테스트 인터페이스 사용**: 웹 페이지에서 제공하는 API 테스트 도구 활용
3. **직접 로그인 테스트**: BioStar X 서버에 직접 로그인하여 세션 테스트

### 2. BioStar X Plugin으로 연동

#### Step 1: 플러그인 등록
1. **BioStar X Service Manager 접속**
2. **Plugins 페이지 이동**  
3. **"Add Plugin" 클릭**
4. **플러그인 정보 입력**:
   - **Name**: SessionBridge Test
   - **URL**: `http://your-server-ip:8000/bsx`
   - **Description**: SessionBridge 테스트 플러그인
   - **Session Bridge**: 활성화

#### Step 2: 플러그인 사용
1. **BioStar X Launcher 접속**
2. **등록된 플러그인 아이콘 클릭**  
3. **새 브라우저 창에서 플러그인 페이지 열림**
4. **자동 세션 인증을 통해 BioStar API 접근**

## API 엔드포인트

### 세션 관리 API

| HTTP 메서드 | 엔드포인트 | 설명 | 매개변수 |
|-------------|------------|------|----------|
| GET | `/bsx` | 플러그인 등록 확인 (Ping) | `X-BioStar-Ping` 헤더 |
| POST | `/bsx` | 플러그인 콜백 (SessionBridge) | `user_id`, `plugin_id` |
| POST | `/login` | BioStar X 직접 로그인 | `server`, `username`, `password` |
| GET | `/session/info` | 현재 세션 정보 조회 | - |
| GET | `/session/logout` | 세션 로그아웃 | - |

### BioStar API 프록시

| HTTP 메서드 | 엔드포인트 | 설명 |
|-------------|------------|------|
| GET | `/api/users` | 사용자 목록 조회 |
| GET | `/api/devices` | 장치 목록 조회 |
| GET/POST/PUT/DELETE | `/biostar/*` | BioStar API 직접 프록시 |

## 핵심 구현 코드

### 1. 플러그인 등록 엔드포인트

```python
@app.get("/bsx")
async def bsx_ping(request: Request):
    """BioStar 플러그인 등록용 ping 엔드포인트"""
    ping_token = request.headers.get("x-biostar-ping")
    
    logger.info(f"Received ping token: {ping_token}")
    
    response_data = {"token": ping_token}
    response = JSONResponse(content=response_data)
    return response
```

### 2. SessionBridge 콜백 처리

```python
@app.post("/bsx")
async def bsx_callback(
    request: Request,
    user_id: str = Form(None),
    plugin_id: str = Form(None)
):
    """BioStar 플러그인 콜백 처리"""
    
    logger.info(f"Plugin callback - user_id: {user_id}, plugin_id: {plugin_id}")
    
    if not user_id:
        raise HTTPException(status_code=400, detail="user_id is required")
    if not plugin_id:
        raise HTTPException(status_code=400, detail="plugin_id is required")

    # AES 키 생성
    key = uuid.uuid4().hex
    logger.info(f"Generated AES key: {key[:8]}...")

    # RSA 공개키로 키 암호화
    encrypted_key = encrypt_with_public_key(key, FILE_CONFIG["public_key_path"])

    # BioStar 서버에 세션 브리지 요청
    payload = {
        "user_id": user_id,
        "plugin_id": plugin_id,
        "key": encrypted_key
    }

    response = requests.post(
        f"https://{SERVER_CONFIG['address']}:{SERVER_CONFIG['port']}/api/session/bridge",
        json=payload,
        verify=SERVER_CONFIG["ssl_verify"]
    )

    if response.status_code == 200:
        data = response.json()
        if data.get("Response", {}).get("code") == "0":
            # 세션 ID 복호화
            encrypted_session = data.get("bs_session_id")
            bs_session_id = decrypt_aes256_base64(encrypted_session, key)
            
            # 세션 저장
            session_data = {
                "user_id": user_id,
                "plugin_id": plugin_id,
                "bs_session_id": bs_session_id
            }
            
            return render_plugin_page(session_data)
        else:
            error_msg = data.get("Response", {}).get("message", "Unknown error")
            raise HTTPException(status_code=400, detail=f"BioStar error: {error_msg}")
    else:
        raise HTTPException(status_code=500, detail="Failed to connect to BioStar server")
```

### 3. RSA 암호화 구현

```python
from cryptography.hazmat.primitives import serialization, padding
import base64

def encrypt_with_public_key(message: str, public_key_path: str) -> str:
    """RSA 공개키로 메시지 암호화"""
    with open(public_key_path, 'rb') as key_file:
        public_key = serialization.load_pem_public_key(key_file.read())

    message_bytes = message.encode('utf-8')
    encrypted = public_key.encrypt(message_bytes, padding.PKCS1v15())
    return base64.b64encode(encrypted).decode('utf-8')
```

### 4. AES 복호화 구현

```python
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
import base64

def decrypt_aes256_base64(encrypted_data: str, key: str) -> str:
    """AES256으로 암호화된 base64 데이터 복호화"""
    key_bytes = key.encode('utf-8')
    
    # 32바이트 키 보장
    if len(key_bytes) != 32:
        if len(key_bytes) < 32:
            key_bytes = key_bytes.ljust(32, b'\0')
        else:
            key_bytes = key_bytes[:32]

    cipher_text = base64.b64decode(encrypted_data)
    iv = key_bytes[:16]  # 첫 16바이트를 IV로 사용

    cipher = AES.new(key_bytes, AES.MODE_CBC, iv)
    decrypted = unpad(cipher.decrypt(cipher_text), AES.block_size)
    return decrypted.decode('utf-8')
```

## 프로젝트 구조

```
BioStarX-session-bridge/
├── web/
│   ├── main.py              # FastAPI 웹 애플리케이션 메인
│   ├── config.py            # 서버 및 API 설정
│   ├── bsapi.py            # BioStar API 클라이언트  
│   ├── run_server.py       # 서버 실행 스크립트
│   ├── requirements.txt    # Python 의존성 목록
│   ├── public_key.pem      # RSA 공개키 파일 (다운로드 필요)
│   └── static/
│       ├── biostar.html   # 웹 테스트 인터페이스
│       └── error.html     # 에러 페이지 템플릿
├── guide.md               # 개발자 가이드
└── README.md             # 프로젝트 README
```

## 세션 관리 상세

### 세션 저장 방식

예제에서는 개발/테스트 편의를 위해 메모리 기반 세션 저장을 사용합니다:

```python
# 메모리 기반 세션 저장소 (개발/테스트용)
sessions = {}

def save_session(session_id: str, session_data: dict):
    """세션 데이터 저장"""
    sessions[session_id] = {
        **session_data,
        "created_at": datetime.now(),
        "last_accessed": datetime.now()
    }

def get_session(session_id: str) -> dict:
    """세션 데이터 조회"""
    if session_id in sessions:
        sessions[session_id]["last_accessed"] = datetime.now()
        return sessions[session_id]
    return None

def remove_session(session_id: str):
    """세션 삭제"""
    if session_id in sessions:
        del sessions[session_id]
```

### 세션 구조

각 세션에는 다음 정보가 포함됩니다:

```python
session_data = {
    "user_id": "admin",           # BioStar X 사용자 ID
    "plugin_id": "test_plugin",   # 플러그인 ID  
    "bs_session_id": "abc123...", # BioStar X 세션 ID
    "created_at": datetime.now(), # 세션 생성 시간
    "last_accessed": datetime.now() # 마지막 접근 시간
}
```

## 테스트 방법

### 1. 기본 기능 테스트

**Ping 엔드포인트 테스트:**
```bash
curl -H "X-BioStar-Ping: test123" http://localhost:8000/bsx
```

**예상 응답:**
```json
{
    "token": "test123"
}
```

**직접 로그인 테스트:**
```bash
curl -X POST http://localhost:8000/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "server=192.168.1.2&username=admin&password=admin"
```

### 2. 웹 인터페이스 테스트

1. **브라우저에서 `http://localhost:8000` 접속**
2. **"직접 로그인" 섹션에서 BioStar X 서버 정보 입력**
3. **"로그인" 버튼 클릭하여 세션 생성 테스트**
4. **"API 테스트" 섹션에서 각종 API 호출 테스트**

### 3. 플러그인 연동 테스트

1. **예제 서버 실행**
2. **BioStar X에서 플러그인 등록**
3. **Launcher에서 플러그인 아이콘 클릭**
4. **자동 세션 브리지를 통한 인증 확인**

## 오류 처리

### API 요청 오류

API 요청에 대한 오류는 JSON 형태로 응답됩니다:

```json
{
    "detail": "user_id is required"
}
```

### 웹 브라우저 오류

웹 브라우저 요청에 대한 오류는 HTML 페이지로 표시됩니다:

```html
<!DOCTYPE html>
<html>
<head>
    <title>오류 발생</title>
    <meta http-equiv="refresh" content="30;url=/">
</head>
<body>
    <h1>서비스 오류</h1>
    <p>요청 처리 중 오류가 발생했습니다.</p>
    <p>30초 후 자동으로 홈페이지로 이동합니다.</p>
</body>
</html>
```

## 보안 고려사항

:::warning
**개발/테스트 전용**: 이 예제는 개발 및 테스트 목적으로 설계되었습니다.
:::

### 운영 환경에서의 개선 사항

**세션 저장소:**
- Redis 또는 데이터베이스를 이용한 영구 세션 저장
- 세션 만료 및 자동 정리 메커니즘 구현

**보안 강화:**
- HTTPS 프로토콜 사용 및 SSL 인증서 적용
- 세션 토큰 암호화 및 서명 검증
- 요청 속도 제한 (Rate Limiting) 구현

**모니터링:**
- 적절한 로깅 시스템 구축
- 성능 모니터링 및 알림 시스템
- 보안 이벤트 추적 및 분석

## 의존성 패키지

예제에서 사용하는 주요 Python 패키지들:

```txt
fastapi>=0.68.0           # 웹 프레임워크
uvicorn[standard]>=0.15.0 # ASGI 서버
requests>=2.28.0          # HTTP 클라이언트
cryptography>=3.4.8      # RSA 암호화
pycryptodome>=3.15.0      # AES 복호화  
python-multipart>=0.0.5  # Form 데이터 처리
```

## 문제 해결

### 일반적인 문제들

**공개키 파일 오류:**
```
FileNotFoundError: [Errno 2] No such file or directory: 'public_key.pem'
```
**해결방법**: BioStar X Service Manager에서 인증서를 다운로드하고 올바른 위치에 배치

**포트 충돌 오류:**
```
OSError: [Errno 98] Address already in use
```
**해결방법**: 다른 포트 사용하거나 기존 프로세스 종료

**BioStar 연결 오류:**
```
requests.exceptions.ConnectionError: HTTPSConnectionPool
```
**해결방법**: `config.py`에서 서버 주소와 포트 확인

### 로그 확인

서버 실행 시 콘솔에 출력되는 로그를 통해 문제를 진단할 수 있습니다:

```
INFO:     Started server process [12346]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     "GET /bsx HTTP/1.1" 200 OK
INFO:     Received ping token: test123
```

## 다음 단계

이 예제를 바탕으로 실제 플러그인을 개발하려면:

1. **요구사항 분석**: 개발할 플러그인의 기능 정의
2. **UI/UX 설계**: 사용자 인터페이스 설계
3. **데이터베이스 설계**: 필요한 데이터 구조 설계
4. **보안 강화**: 운영 환경에 맞는 보안 기능 구현
5. **테스트**: 단위 테스트 및 통합 테스트 수행
6. **배포**: 운영 환경 배포 및 모니터링

관련 문서:
- [개발 가이드](./development-guide) - 플러그인 개발 상세 방법
- [등록 가이드](./registration-guide) - 플러그인 등록 및 관리
- [문제 해결](./troubleshooting) - 개발 중 발생하는 문제 해결
