name: Generate PDF Document with Cover

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: "제품명 (예: BioStation 3, BioStar 2)"
        required: true
        default: "BioStation 3"
      document_type:
        description: "문서 유형 (예: IG, UG, AG)"
        required: true
        default: "IG"
      version:
        description: "문서 버전"
        required: true
        default: "1.0.0"
      language:
        description: "언어 (한국어/English)"
        required: true
        default: "한국어"
        type: choice
        options:
          - "한국어"
          - "English"
      document_number:
        description: "문서 번호 (예: KO 101.00.BS3)"
        required: true
        default: "KO 101.00.BS3"
      target_url:
        description: "PDF로 변환할 웹사이트 URL"
        required: true
        default: "https://docs.supremainc.com/device/biostation_3"
      release_date:
        description: "릴리스 날짜 (YYMMDD 형식)"
        required: true
        default: "YYMMDD"

permissions:
  contents: write

env:
  PRINCE_VER: 16

jobs:
  generate-pdf:
    name: Generate Complete PDF Document
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Print workflow inputs
      run: |
        echo "=== 워크플로우 입력값 ==="
        echo "제품명: ${{ github.event.inputs.product_name }}"
        echo "문서 유형: ${{ github.event.inputs.document_type }}"
        echo "버전: ${{ github.event.inputs.version }}"
        echo "언어: ${{ github.event.inputs.language }}"
        echo "문서 번호: ${{ github.event.inputs.document_number }}"
        echo "대상 URL: ${{ github.event.inputs.target_url }}"
        echo "릴리스 날짜: ${{ github.event.inputs.release_date }}"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Install Prince XML
      run: |
        curl https://www.princexml.com/download/prince-${{ env.PRINCE_VER }}-macos.zip -O
        tar zxf prince-${{ env.PRINCE_VER }}-macos.zip
        cd prince-${{ env.PRINCE_VER }}-macos
        yes "" | sudo ./install.sh

    - name: Install pdfcpu
      run: brew install pdfcpu

    - name: Install PDFtk
      run: brew install pdftk-java

    - name: Install GitHub CLI
      run: brew install gh

    - name: Create PDF output directory
      run: mkdir -p ./pdf

    - name: Generate front cover PDF
      run: |
        echo "📄 프론트 커버 생성 중..."
        
        # 언어별 문서 번호 및 커버 설정
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
          COVER_TITLE="${{ github.event.inputs.product_name }}"
          COVER_SUBTITLE="${{ github.event.inputs.document_type }}"
          COVER_VERSION="Version ${{ github.event.inputs.version }}"
          COVER_LANG="English"
          BACK_COVER="back-cover-en.pdf"
        else
          LANG_CODE="KO"
          COVER_TITLE="${{ github.event.inputs.product_name }}"
          COVER_SUBTITLE="${{ github.event.inputs.document_type }}"
          COVER_VERSION="버전 ${{ github.event.inputs.version }}"
          COVER_LANG="한국어"
          BACK_COVER="back-cover.pdf"
        fi
        
        # 프론트 커버 생성
        node generate-cover-local.js \
          --title="$COVER_TITLE" \
          --subtitle="$COVER_SUBTITLE" \
          --version="${{ github.event.inputs.version }}" \
          --lang="$COVER_LANG" \
          --number="${{ github.event.inputs.document_number }}" \
          --output="./pdf/front-cover.html"
        
        # HTML을 PDF로 변환
        prince "./pdf/front-cover.html" -o "./pdf/front-cover.pdf"
        
        # 프론트 커버 PDF에서 주석 제거
        pdfcpu annot remove "./pdf/front-cover.pdf"
        
        echo "✅ 프론트 커버 완료 (주석 제거됨): ./pdf/front-cover.pdf"

    - name: Generate main document PDF
      run: |
        echo "📖 메인 문서 PDF 생성 중..."
        
        # 언어별 파일명 설정
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        # 파일명 생성 (공백을 언더스코어로 변경)
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        MAIN_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}.pdf"
        
        # Prince XML로 웹페이지를 PDF로 변환
        node generatepdf \
          -u "${{ github.event.inputs.target_url }}" \
          --prince-args="--page-size='a4' --style=./print.css --javascript" \
          -o "./pdf/${MAIN_PDF_NAME}" \
          --dest ./pdf \
          --include-index
        
        echo "MAIN_PDF_NAME=${MAIN_PDF_NAME}" >> $GITHUB_ENV
        echo "✅ 메인 문서 완료: ./pdf/${MAIN_PDF_NAME}"

    - name: Remove annotations from main PDF
      run: |
        echo "🔧 PDF 주석 제거 중..."
        
        # 파일명 재생성
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        MAIN_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}.pdf"
        
        pdfcpu annot remove -pages 1 "./pdf/${MAIN_PDF_NAME}"
        echo "MAIN_PDF_NAME=${MAIN_PDF_NAME}" >> $GITHUB_ENV
        echo "✅ 주석 제거 완료"

    - name: Merge all PDFs
      run: |
        echo "📑 PDF 파일 병합 중 (북마크 보존)..."
        
        # 파일명 재생성
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
          BACK_COVER="back-cover-en.pdf"
        else
          LANG_CODE="KO"
          BACK_COVER="back-cover.pdf"
        fi
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        MAIN_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}.pdf"
        FINAL_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}_Final.pdf"
        
        # PDFtk를 사용하여 북마크를 보존하면서 병합
        echo "📎 PDFtk로 PDF 병합 중 (북마크 보존)..."
        pdftk "./pdf/front-cover.pdf" "./pdf/${MAIN_PDF_NAME}" "$BACK_COVER" cat output "./pdf/${FINAL_PDF_NAME}"
        
        echo "FINAL_PDF_NAME=${FINAL_PDF_NAME}" >> $GITHUB_ENV
        echo "✅ PDF 병합 완료 (북마크 보존): ./pdf/${FINAL_PDF_NAME}"

    - name: Configure PDF viewer preferences
      run: |
        echo "⚙️ PDF 뷰어 설정 적용 중..."
        
        # 파일명 재생성
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        FINAL_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}_Final.pdf"
        
        # 뷰어 기본 설정 적용
        echo "📖 책갈피 패널 표시 설정..."
        pdfcpu pagemode set "./pdf/${FINAL_PDF_NAME}" UseOutlines
        
        echo "📄 한 페이지 레이아웃 설정..."
        pdfcpu pagelayout set "./pdf/${FINAL_PDF_NAME}" SinglePage
        
        echo "🔍 페이지에 맞추기 및 기타 뷰어 설정..."
        pdfcpu viewerpref set "./pdf/${FINAL_PDF_NAME}" '{"FitWindow": true, "CenterWindow": true}'
        
        echo "✅ PDF 뷰어 설정 완료:"
        echo "  📖 페이지 모드: UseOutlines (책갈피 패널 표시)"
        echo "  📄 페이지 레이아웃: SinglePage (한 페이지)"
        echo "  🔍 창 크기: FitWindow (페이지에 맞추기)"
        echo "  🎯 창 위치: CenterWindow (화면 중앙)"

    - name: Check and prepare release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 언어 코드 설정
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
          LANG_DISPLAY="English"
        else
          LANG_CODE="KO"
          LANG_DISPLAY="한국어"
        fi
        
        # 태그명을 워크플로우 입력값 그대로 사용
        TAG_NAME="v${{ github.event.inputs.version }}"
        RELEASE_TITLE="${{ github.event.inputs.product_name }} ${{ github.event.inputs.document_type }} v${{ github.event.inputs.version }} (${LANG_DISPLAY})"
        
        echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
        echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_ENV
        echo "LANG_CODE=${LANG_CODE}" >> $GITHUB_ENV
        echo "LANG_DISPLAY=${LANG_DISPLAY}" >> $GITHUB_ENV
        
        # 기존 태그가 있는지 확인
        if git rev-parse --verify "refs/tags/${TAG_NAME}" >/dev/null 2>&1; then
          echo "📌 기존 태그가 발견되었습니다: $TAG_NAME"
          echo "TAG_EXISTS=true" >> $GITHUB_ENV
        else
          echo "🆕 새로운 태그를 생성합니다: $TAG_NAME"
          echo "TAG_EXISTS=false" >> $GITHUB_ENV
        fi
        
        # 동일한 제목의 릴리스가 있는지 확인 후 삭제
        if gh release view "$TAG_NAME" &>/dev/null; then
          EXISTING_TITLE=$(gh release view "$TAG_NAME" --json name --jq '.name')
          if [ "$EXISTING_TITLE" = "$RELEASE_TITLE" ]; then
            echo "�️ 동일한 제목의 릴리스를 삭제합니다: $RELEASE_TITLE"
            gh release delete "$TAG_NAME" -y
            # 태그는 유지하되 릴리스만 삭제
            echo "RELEASE_EXISTS=false" >> $GITHUB_ENV
          else
            echo "📝 다른 제목의 릴리스가 존재합니다. 기존: $EXISTING_TITLE, 새로운: $RELEASE_TITLE"
            gh release delete "$TAG_NAME" -y
            echo "RELEASE_EXISTS=false" >> $GITHUB_ENV
          fi
        else
          echo "🆕 새로운 릴리스를 생성합니다"
          echo "RELEASE_EXISTS=false" >> $GITHUB_ENV
        fi
      continue-on-error: true

    - name: Set release variables
      run: |
        # 모든 변수를 다시 설정 (이미 환경변수에 설정되어 있음)
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        TAG_NAME="v${{ github.event.inputs.version }}"
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        FINAL_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}_Final.pdf"
        
        echo "FINAL_PDF_NAME=${FINAL_PDF_NAME}" >> $GITHUB_ENV

    - name: Create or update GitHub Release
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 환경변수에서 값 가져오기
        TAG_NAME="${TAG_NAME}"
        RELEASE_TITLE="${RELEASE_TITLE}"
        
        # 릴리스 노트 작성
        cat > release_notes.md << EOF
        # ${{ github.event.inputs.product_name }} ${{ github.event.inputs.document_type }}

        **버전:** ${{ github.event.inputs.version }}
        **문서 번호:** ${{ github.event.inputs.document_number }}
        **릴리스 날짜:** ${{ github.event.inputs.release_date }}
        **언어:** ${LANG_DISPLAY}
        **소스 URL:** ${{ github.event.inputs.target_url }}
        EOF
        
        # 항상 새로운 릴리스 생성 (기존 릴리스는 이미 삭제됨)
        echo "🆕 새로운 릴리스 생성 중..."
        echo "📌 태그: $TAG_NAME"
        echo "📝 제목: $RELEASE_TITLE"
        
        if [ "$TAG_EXISTS" = "true" ]; then
          # 기존 태그 사용
          gh release create "$TAG_NAME" \
            --title "$RELEASE_TITLE" \
            --notes-file release_notes.md \
            --target main
        else
          # 새로운 태그와 릴리스 생성
          gh release create "$TAG_NAME" \
            --title "$RELEASE_TITLE" \
            --notes-file release_notes.md
        fi

    - name: Upload PDF to Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 환경변수에서 값 가져오기
        TAG_NAME="${TAG_NAME}"
        FINAL_PDF_NAME="${FINAL_PDF_NAME}"
        
        echo "📎 PDF 파일을 릴리스에 업로드 중..."
        echo "📌 태그: $TAG_NAME"
        echo "📄 파일: $FINAL_PDF_NAME"
        
        gh release upload "$TAG_NAME" "./pdf/$FINAL_PDF_NAME" --clobber

    - name: Show completion summary
      run: |
        # 환경변수에서 값 가져오기
        TAG_NAME="${TAG_NAME}"
        RELEASE_TITLE="${RELEASE_TITLE}"
        FINAL_PDF_NAME="${FINAL_PDF_NAME}"
        
        echo "🎉 PDF 생성 및 릴리스 완료!"
        echo "=========================="
        echo "📁 생성된 파일:"
        ls -la ./pdf/
        echo "=========================="
        echo "🔗 릴리스: https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
        echo "📝 릴리스 제목: ${RELEASE_TITLE}"
        echo "📄 업로드된 파일: ${FINAL_PDF_NAME}"
        echo "🌐 언어: ${{ github.event.inputs.language }}"
