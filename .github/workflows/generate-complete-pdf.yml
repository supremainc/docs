name: Generate PDF Document with Cover

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: "ì œí’ˆëª… (ì˜ˆ: BioStation 3, BioStar 2)"
        required: true
        default: "BioStation 3"
      document_type:
        description: "ë¬¸ì„œ ìœ í˜• (ì˜ˆ: IG, UG, AG)"
        required: true
        default: "IG"
      version:
        description: "ë¬¸ì„œ ë²„ì „"
        required: true
        default: "1.0.0"
      language:
        description: "ì–¸ì–´ (í•œêµ­ì–´/English)"
        required: true
        default: "í•œêµ­ì–´"
        type: choice
        options:
          - "í•œêµ­ì–´"
          - "English"
      document_number:
        description: "ë¬¸ì„œ ë²ˆí˜¸ (ì˜ˆ: KO 101.00.BS3)"
        required: true
        default: "KO 101.00.BS3"
      target_url:
        description: "PDFë¡œ ë³€í™˜í•  ì›¹ì‚¬ì´íŠ¸ URL"
        required: true
        default: "https://docs.supremainc.com/device/biostation_3"
      release_date:
        description: "ë¦´ë¦¬ìŠ¤ ë‚ ì§œ (YYMMDD í˜•ì‹)"
        required: true
        default: "YYMMDD"

permissions:
  contents: write

env:
  PRINCE_VER: 16

jobs:
  generate-pdf:
    name: Generate Complete PDF Document
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Print workflow inputs
      run: |
        echo "=== ì›Œí¬í”Œë¡œìš° ìž…ë ¥ê°’ ==="
        echo "ì œí’ˆëª…: ${{ github.event.inputs.product_name }}"
        echo "ë¬¸ì„œ ìœ í˜•: ${{ github.event.inputs.document_type }}"
        echo "ë²„ì „: ${{ github.event.inputs.version }}"
        echo "ì–¸ì–´: ${{ github.event.inputs.language }}"
        echo "ë¬¸ì„œ ë²ˆí˜¸: ${{ github.event.inputs.document_number }}"
        echo "ëŒ€ìƒ URL: ${{ github.event.inputs.target_url }}"
        echo "ë¦´ë¦¬ìŠ¤ ë‚ ì§œ: ${{ github.event.inputs.release_date }}"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Install Prince XML
      run: |
        curl https://www.princexml.com/download/prince-${{ env.PRINCE_VER }}-macos.zip -O
        tar zxf prince-${{ env.PRINCE_VER }}-macos.zip
        cd prince-${{ env.PRINCE_VER }}-macos
        yes "" | sudo ./install.sh

    - name: Install pdfcpu
      run: brew install pdfcpu

    - name: Install PDFtk
      run: brew install pdftk-java

    - name: Install GitHub CLI
      run: brew install gh

    - name: Create PDF output directory
      run: mkdir -p ./pdf

    - name: Generate front cover PDF
      run: |
        echo "ðŸ“„ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì¤‘..."
        
        # ì–¸ì–´ë³„ ë¬¸ì„œ ë²ˆí˜¸ ë° ì»¤ë²„ ì„¤ì •
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
          COVER_TITLE="${{ github.event.inputs.product_name }}"
          COVER_SUBTITLE="${{ github.event.inputs.document_type }}"
          COVER_VERSION="Version ${{ github.event.inputs.version }}"
          COVER_LANG="English"
          BACK_COVER="back-cover-en.pdf"
        else
          LANG_CODE="KO"
          COVER_TITLE="${{ github.event.inputs.product_name }}"
          COVER_SUBTITLE="${{ github.event.inputs.document_type }}"
          COVER_VERSION="ë²„ì „ ${{ github.event.inputs.version }}"
          COVER_LANG="í•œêµ­ì–´"
          BACK_COVER="back-cover.pdf"
        fi
        
        # í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„±
        node generate-cover-local.js \
          --title="$COVER_TITLE" \
          --subtitle="$COVER_SUBTITLE" \
          --version="${{ github.event.inputs.version }}" \
          --lang="$COVER_LANG" \
          --number="${{ github.event.inputs.document_number }}" \
          --output="./pdf/front-cover.html"
        
        # HTMLì„ PDFë¡œ ë³€í™˜
        prince "./pdf/front-cover.html" -o "./pdf/front-cover.pdf"
        
        # í”„ë¡ íŠ¸ ì»¤ë²„ PDFì—ì„œ ì£¼ì„ ì œê±°
        pdfcpu annot remove "./pdf/front-cover.pdf"
        
        echo "âœ… í”„ë¡ íŠ¸ ì»¤ë²„ ì™„ë£Œ (ì£¼ì„ ì œê±°ë¨): ./pdf/front-cover.pdf"

    - name: Generate main document PDF
      run: |
        echo "ðŸ“– ë©”ì¸ ë¬¸ì„œ PDF ìƒì„± ì¤‘..."
        
        # ì–¸ì–´ë³„ íŒŒì¼ëª… ì„¤ì •
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        # íŒŒì¼ëª… ìƒì„± (ê³µë°±ì„ ì–¸ë”ìŠ¤ì½”ì–´ë¡œ ë³€ê²½)
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        MAIN_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}.pdf"
        
        # Prince XMLë¡œ ì›¹íŽ˜ì´ì§€ë¥¼ PDFë¡œ ë³€í™˜
        node generatepdf \
          -u "${{ github.event.inputs.target_url }}" \
          --prince-args="--page-size='a4' --style=./print.css --javascript" \
          -o "./pdf/${MAIN_PDF_NAME}" \
          --dest ./pdf \
          --include-index
        
        echo "MAIN_PDF_NAME=${MAIN_PDF_NAME}" >> $GITHUB_ENV
        echo "âœ… ë©”ì¸ ë¬¸ì„œ ì™„ë£Œ: ./pdf/${MAIN_PDF_NAME}"

    - name: Remove annotations from main PDF
      run: |
        echo "ðŸ”§ PDF ì£¼ì„ ì œê±° ì¤‘..."
        
        # íŒŒì¼ëª… ìž¬ìƒì„±
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        MAIN_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}.pdf"
        
        pdfcpu annot remove -pages 1 "./pdf/${MAIN_PDF_NAME}"
        echo "MAIN_PDF_NAME=${MAIN_PDF_NAME}" >> $GITHUB_ENV
        echo "âœ… ì£¼ì„ ì œê±° ì™„ë£Œ"

    - name: Merge all PDFs
      run: |
        echo "ðŸ“‘ PDF íŒŒì¼ ë³‘í•© ì¤‘ (ë¶ë§ˆí¬ ë³´ì¡´)..."
        
        # íŒŒì¼ëª… ìž¬ìƒì„±
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
          BACK_COVER="back-cover-en.pdf"
        else
          LANG_CODE="KO"
          BACK_COVER="back-cover.pdf"
        fi
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        MAIN_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}.pdf"
        FINAL_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}_Final.pdf"
        
        # PDFtkë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶ë§ˆí¬ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ë³‘í•©
        echo "ðŸ“Ž PDFtkë¡œ PDF ë³‘í•© ì¤‘ (ë¶ë§ˆí¬ ë³´ì¡´)..."
        pdftk "./pdf/front-cover.pdf" "./pdf/${MAIN_PDF_NAME}" "$BACK_COVER" cat output "./pdf/${FINAL_PDF_NAME}"
        
        echo "FINAL_PDF_NAME=${FINAL_PDF_NAME}" >> $GITHUB_ENV
        echo "âœ… PDF ë³‘í•© ì™„ë£Œ (ë¶ë§ˆí¬ ë³´ì¡´): ./pdf/${FINAL_PDF_NAME}"

    - name: Configure PDF viewer preferences
      run: |
        echo "âš™ï¸ PDF ë·°ì–´ ì„¤ì • ì ìš© ì¤‘..."
        
        # íŒŒì¼ëª… ìž¬ìƒì„±
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        FINAL_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}_Final.pdf"
        
        # ë·°ì–´ ê¸°ë³¸ ì„¤ì • ì ìš©
        echo "ðŸ“– ì±…ê°ˆí”¼ íŒ¨ë„ í‘œì‹œ ì„¤ì •..."
        pdfcpu pagemode set "./pdf/${FINAL_PDF_NAME}" UseOutlines
        
        echo "ðŸ“„ í•œ íŽ˜ì´ì§€ ë ˆì´ì•„ì›ƒ ì„¤ì •..."
        pdfcpu pagelayout set "./pdf/${FINAL_PDF_NAME}" SinglePage
        
        echo "ðŸ” íŽ˜ì´ì§€ì— ë§žì¶”ê¸° ë° ê¸°íƒ€ ë·°ì–´ ì„¤ì •..."
        pdfcpu viewerpref set "./pdf/${FINAL_PDF_NAME}" '{"FitWindow": true, "CenterWindow": true}'
        
        echo "âœ… PDF ë·°ì–´ ì„¤ì • ì™„ë£Œ:"
        echo "  ðŸ“– íŽ˜ì´ì§€ ëª¨ë“œ: UseOutlines (ì±…ê°ˆí”¼ íŒ¨ë„ í‘œì‹œ)"
        echo "  ðŸ“„ íŽ˜ì´ì§€ ë ˆì´ì•„ì›ƒ: SinglePage (í•œ íŽ˜ì´ì§€)"
        echo "  ðŸ” ì°½ í¬ê¸°: FitWindow (íŽ˜ì´ì§€ì— ë§žì¶”ê¸°)"
        echo "  ðŸŽ¯ ì°½ ìœ„ì¹˜: CenterWindow (í™”ë©´ ì¤‘ì•™)"

    - name: Check and prepare release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ì–¸ì–´ ì½”ë“œ ì„¤ì •
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
          LANG_DISPLAY="English"
        else
          LANG_CODE="KO"
          LANG_DISPLAY="í•œêµ­ì–´"
        fi
        
        # íƒœê·¸ëª…ì„ ì›Œí¬í”Œë¡œìš° ìž…ë ¥ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        TAG_NAME="v${{ github.event.inputs.version }}"
        RELEASE_TITLE="${{ github.event.inputs.product_name }} ${{ github.event.inputs.document_type }} v${{ github.event.inputs.version }} (${LANG_DISPLAY})"
        
        echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
        echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_ENV
        echo "LANG_CODE=${LANG_CODE}" >> $GITHUB_ENV
        echo "LANG_DISPLAY=${LANG_DISPLAY}" >> $GITHUB_ENV
        
        # ê¸°ì¡´ íƒœê·¸ê°€ ìžˆëŠ”ì§€ í™•ì¸
        if git rev-parse --verify "refs/tags/${TAG_NAME}" >/dev/null 2>&1; then
          echo "ðŸ“Œ ê¸°ì¡´ íƒœê·¸ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤: $TAG_NAME"
          echo "TAG_EXISTS=true" >> $GITHUB_ENV
        else
          echo "ðŸ†• ìƒˆë¡œìš´ íƒœê·¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤: $TAG_NAME"
          echo "TAG_EXISTS=false" >> $GITHUB_ENV
        fi
        
        # ë™ì¼í•œ ì œëª©ì˜ ë¦´ë¦¬ìŠ¤ê°€ ìžˆëŠ”ì§€ í™•ì¸ í›„ ì‚­ì œ
        if gh release view "$TAG_NAME" &>/dev/null; then
          EXISTING_TITLE=$(gh release view "$TAG_NAME" --json name --jq '.name')
          if [ "$EXISTING_TITLE" = "$RELEASE_TITLE" ]; then
            echo "ï¿½ï¸ ë™ì¼í•œ ì œëª©ì˜ ë¦´ë¦¬ìŠ¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤: $RELEASE_TITLE"
            gh release delete "$TAG_NAME" -y
            # íƒœê·¸ëŠ” ìœ ì§€í•˜ë˜ ë¦´ë¦¬ìŠ¤ë§Œ ì‚­ì œ
            echo "RELEASE_EXISTS=false" >> $GITHUB_ENV
          else
            echo "ðŸ“ ë‹¤ë¥¸ ì œëª©ì˜ ë¦´ë¦¬ìŠ¤ê°€ ì¡´ìž¬í•©ë‹ˆë‹¤. ê¸°ì¡´: $EXISTING_TITLE, ìƒˆë¡œìš´: $RELEASE_TITLE"
            gh release delete "$TAG_NAME" -y
            echo "RELEASE_EXISTS=false" >> $GITHUB_ENV
          fi
        else
          echo "ðŸ†• ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤"
          echo "RELEASE_EXISTS=false" >> $GITHUB_ENV
        fi
      continue-on-error: true

    - name: Set release variables
      run: |
        # ëª¨ë“  ë³€ìˆ˜ë¥¼ ë‹¤ì‹œ ì„¤ì • (ì´ë¯¸ í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ë˜ì–´ ìžˆìŒ)
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
        else
          LANG_CODE="KO"
        fi
        
        TAG_NAME="v${{ github.event.inputs.version }}"
        
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        FINAL_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}_Final.pdf"
        
        echo "FINAL_PDF_NAME=${FINAL_PDF_NAME}" >> $GITHUB_ENV

    - name: Create or update GitHub Release
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        TAG_NAME="${TAG_NAME}"
        RELEASE_TITLE="${RELEASE_TITLE}"
        
        # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìž‘ì„±
        cat > release_notes.md << EOF
        # ${{ github.event.inputs.product_name }} ${{ github.event.inputs.document_type }}

        **ë²„ì „:** ${{ github.event.inputs.version }}
        **ë¬¸ì„œ ë²ˆí˜¸:** ${{ github.event.inputs.document_number }}
        **ë¦´ë¦¬ìŠ¤ ë‚ ì§œ:** ${{ github.event.inputs.release_date }}
        **ì–¸ì–´:** ${LANG_DISPLAY}
        **ì†ŒìŠ¤ URL:** ${{ github.event.inputs.target_url }}
        EOF
        
        # í•­ìƒ ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ ìƒì„± (ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ëŠ” ì´ë¯¸ ì‚­ì œë¨)
        echo "ðŸ†• ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ ìƒì„± ì¤‘..."
        echo "ðŸ“Œ íƒœê·¸: $TAG_NAME"
        echo "ðŸ“ ì œëª©: $RELEASE_TITLE"
        
        if [ "$TAG_EXISTS" = "true" ]; then
          # ê¸°ì¡´ íƒœê·¸ ì‚¬ìš©
          gh release create "$TAG_NAME" \
            --title "$RELEASE_TITLE" \
            --notes-file release_notes.md \
            --target main
        else
          # ìƒˆë¡œìš´ íƒœê·¸ì™€ ë¦´ë¦¬ìŠ¤ ìƒì„±
          gh release create "$TAG_NAME" \
            --title "$RELEASE_TITLE" \
            --notes-file release_notes.md
        fi

    - name: Upload PDF to Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        TAG_NAME="${TAG_NAME}"
        FINAL_PDF_NAME="${FINAL_PDF_NAME}"
        
        echo "ðŸ“Ž PDF íŒŒì¼ì„ ë¦´ë¦¬ìŠ¤ì— ì—…ë¡œë“œ ì¤‘..."
        echo "ðŸ“Œ íƒœê·¸: $TAG_NAME"
        echo "ðŸ“„ íŒŒì¼: $FINAL_PDF_NAME"
        
        gh release upload "$TAG_NAME" "./pdf/$FINAL_PDF_NAME" --clobber

    - name: Show completion summary
      run: |
        # í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        TAG_NAME="${TAG_NAME}"
        RELEASE_TITLE="${RELEASE_TITLE}"
        FINAL_PDF_NAME="${FINAL_PDF_NAME}"
        
        echo "ðŸŽ‰ PDF ìƒì„± ë° ë¦´ë¦¬ìŠ¤ ì™„ë£Œ!"
        echo "=========================="
        echo "ðŸ“ ìƒì„±ëœ íŒŒì¼:"
        ls -la ./pdf/
        echo "=========================="
        echo "ðŸ”— ë¦´ë¦¬ìŠ¤: https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
        echo "ðŸ“ ë¦´ë¦¬ìŠ¤ ì œëª©: ${RELEASE_TITLE}"
        echo "ðŸ“„ ì—…ë¡œë“œëœ íŒŒì¼: ${FINAL_PDF_NAME}"
        echo "ðŸŒ ì–¸ì–´: ${{ github.event.inputs.language }}"
