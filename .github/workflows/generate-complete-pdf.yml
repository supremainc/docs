name: Generate PDF Document with Cover

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: "ì œí’ˆëª… (ì˜ˆ: BioStation 3, BioStar 2)"
        required: true
        default: "BioStation 3"
      document_type:
        description: "ë¬¸ì„œ ìœ í˜• (ì˜ˆ: IG, UG, AG)"
        required: true
        default: "IG"
      version:
        description: "ë¬¸ì„œ ë²„ì „"
        required: true
        default: "1.0.0"
      language:
        description: "ì–¸ì–´ (í•œêµ­ì–´/English)"
        required: true
        default: "í•œêµ­ì–´"
        type: choice
        options:
          - "í•œêµ­ì–´"
          - "English"
      document_number:
        description: "ë¬¸ì„œ ë²ˆí˜¸ (ì˜ˆ: KO 101.00.BS3)"
        required: true
        default: "KO 101.00.BS3"
      target_url:
        description: "PDFë¡œ ë³€í™˜í•  ì›¹ì‚¬ì´íŠ¸ URL"
        required: true
        default: "https://docs.supremainc.com/device/biostation_3"
      release_date:
        description: "ë¦´ë¦¬ìŠ¤ ë‚ ì§œ (YYMMDD í˜•ì‹)"
        required: true
        default: "YYMMDD"

permissions:
  contents: write

env:
  PRINCE_VER: 16

jobs:
  generate-pdf:
    name: Generate Complete PDF Document
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate inputs
      run: |
        echo "ðŸ” ìž…ë ¥ê°’ ê²€ì¦ ì¤‘..."
        
        # URL ìœ íš¨ì„± ê²€ì‚¬
        if ! curl -sSf --head "${{ github.event.inputs.target_url }}" > /dev/null; then
          echo "âŒ ì˜¤ë¥˜: ëŒ€ìƒ URLì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ github.event.inputs.target_url }}"
          exit 1
        fi
        
        # ë‚ ì§œ í˜•ì‹ ê²€ì¦ (YYMMDD)
        if ! echo "${{ github.event.inputs.release_date }}" | grep -qE '^[0-9]{6}$'; then
          echo "âŒ ì˜¤ë¥˜: ë¦´ë¦¬ìŠ¤ ë‚ ì§œëŠ” YYMMDD í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤: ${{ github.event.inputs.release_date }}"
          exit 1
        fi
        
        # ë²„ì „ í˜•ì‹ ê²€ì¦ (semantic version)
        if ! echo "${{ github.event.inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
          echo "âŒ ì˜¤ë¥˜: ë²„ì „ì€ x.y.z í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤: ${{ github.event.inputs.version }}"
          exit 1
        fi
        
        echo "âœ… ëª¨ë“  ìž…ë ¥ê°’ì´ ìœ íš¨í•©ë‹ˆë‹¤"

    - name: Print workflow inputs
      run: |
        echo "=== ì›Œí¬í”Œë¡œìš° ìž…ë ¥ê°’ ==="
        echo "ì œí’ˆëª…: ${{ github.event.inputs.product_name }}"
        echo "ë¬¸ì„œ ìœ í˜•: ${{ github.event.inputs.document_type }}"
        echo "ë²„ì „: ${{ github.event.inputs.version }}"
        echo "ì–¸ì–´: ${{ github.event.inputs.language }}"
        echo "ë¬¸ì„œ ë²ˆí˜¸: ${{ github.event.inputs.document_number }}"
        echo "ëŒ€ìƒ URL: ${{ github.event.inputs.target_url }}"
        echo "ë¦´ë¦¬ìŠ¤ ë‚ ì§œ: ${{ github.event.inputs.release_date }}"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Setup tools cache
      id: tools-cache
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/bin/prince
          /opt/homebrew/bin/pdfcpu
          /opt/homebrew/bin/pdftk
          /opt/homebrew/bin/gh
        key: tools-${{ runner.os }}-${{ env.PRINCE_VER }}

    - name: Install Prince XML
      if: steps.tools-cache.outputs.cache-hit != 'true'
      run: |
        echo "ðŸ“¦ Prince XML ì„¤ì¹˜ ì¤‘..."
        curl https://www.princexml.com/download/prince-${{ env.PRINCE_VER }}-macos.zip -O
        tar zxf prince-${{ env.PRINCE_VER }}-macos.zip
        cd prince-${{ env.PRINCE_VER }}-macos
        yes "" | sudo ./install.sh
        echo "âœ… Prince XML ì„¤ì¹˜ ì™„ë£Œ"

    - name: Install other tools
      if: steps.tools-cache.outputs.cache-hit != 'true'
      run: |
        echo "ðŸ“¦ ê¸°íƒ€ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."
        # ë³‘ë ¬ë¡œ ì„¤ì¹˜í•˜ì—¬ ì‹œê°„ ë‹¨ì¶•
        brew install pdfcpu pdftk-java gh
        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"

    - name: Verify tools installation
      run: |
        echo "ðŸ”§ ë„êµ¬ ì„¤ì¹˜ í™•ì¸ ì¤‘..."
        prince --version || echo "Prince XML í™•ì¸ í•„ìš”"
        pdfcpu version || echo "pdfcpu í™•ì¸ í•„ìš”"  
        pdftk --version || echo "PDFtk í™•ì¸ í•„ìš”"
        gh --version || echo "GitHub CLI í™•ì¸ í•„ìš”"
        echo "âœ… ë„êµ¬ í™•ì¸ ì™„ë£Œ"

    - name: Setup environment variables
      run: |
        echo "ðŸ“Š í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
        
        # ì–¸ì–´ ì½”ë“œ ì„¤ì •
        if [ "${{ github.event.inputs.language }}" = "English" ]; then
          LANG_CODE="EN"
          LANG_DISPLAY="English"
          BACK_COVER="back-cover-en.pdf"
          COVER_VERSION="Version ${{ github.event.inputs.version }}"
        else
          LANG_CODE="KO"
          LANG_DISPLAY="í•œêµ­ì–´"
          BACK_COVER="back-cover.pdf"
          COVER_VERSION="ë²„ì „ ${{ github.event.inputs.version }}"
        fi
        
        # íŒŒì¼ëª…ìš© ì•ˆì „í•œ ë¬¸ìžì—´ ìƒì„±
        PRODUCT_SAFE=$(echo "${{ github.event.inputs.product_name }}" | sed 's/ /_/g')
        DOC_TYPE_SAFE=$(echo "${{ github.event.inputs.document_type }}" | sed 's/ /_/g')
        
        # GitHub íƒœê·¸ëª…ìš© ì•ˆì „í•œ ë¦´ë¦¬ìŠ¤ëª… ì„¤ì • (ê³µë°±, í•œê¸€ ë“±ì„ ì•ˆì „í•œ ë¬¸ìžë¡œ ë³€ê²½)
        RELEASE_NAME="${PRODUCT_SAFE}-${DOC_TYPE_SAFE}-${LANG_CODE}-${{ github.event.inputs.version }}"
        
        # ì‚¬ìš©ìž ì¹œí™”ì ì¸ ë¦´ë¦¬ìŠ¤ ì œëª© (ê³µë°±ê³¼ í•œê¸€ í¬í•¨ ê°€ëŠ¥)
        RELEASE_TITLE="${{ github.event.inputs.product_name }} ${{ github.event.inputs.document_type }} (${{ github.event.inputs.language }}) v${{ github.event.inputs.version }}"
        
        # PDF íŒŒì¼ëª…ë“¤ ì„¤ì •
        MAIN_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}.pdf"
        FINAL_PDF_NAME="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_${LANG_CODE}_${{ github.event.inputs.release_date }}_Final.pdf"
        
        # í™˜ê²½ë³€ìˆ˜ë¡œ ì €ìž¥
        echo "LANG_CODE=${LANG_CODE}" >> $GITHUB_ENV
        echo "LANG_DISPLAY=${LANG_DISPLAY}" >> $GITHUB_ENV
        echo "BACK_COVER=${BACK_COVER}" >> $GITHUB_ENV
        echo "COVER_VERSION=${COVER_VERSION}" >> $GITHUB_ENV
        echo "PRODUCT_SAFE=${PRODUCT_SAFE}" >> $GITHUB_ENV
        echo "DOC_TYPE_SAFE=${DOC_TYPE_SAFE}" >> $GITHUB_ENV
        echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_ENV
        echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_ENV
        echo "MAIN_PDF_NAME=${MAIN_PDF_NAME}" >> $GITHUB_ENV
        echo "FINAL_PDF_NAME=${FINAL_PDF_NAME}" >> $GITHUB_ENV
        
        echo "âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ:"
        echo "  ðŸŒ ì–¸ì–´: ${LANG_DISPLAY} (${LANG_CODE})"
        echo "  ðŸ·ï¸ íƒœê·¸ëª…: ${RELEASE_NAME}"
        echo "  ðŸ“ ë¦´ë¦¬ìŠ¤ ì œëª©: ${RELEASE_TITLE}"
        echo "  ðŸ“„ ìµœì¢… PDF: ${FINAL_PDF_NAME}"

    - name: Create PDF output directory
      run: mkdir -p ./pdf

    - name: Generate and process PDFs
      run: |
        echo "ðŸ“„ PDF ìƒì„± ë° ì²˜ë¦¬ ì‹œìž‘..."
        
        # í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„±
        echo "ðŸ“„ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì¤‘..."
        node generate-cover-local.js \
          --title="${{ github.event.inputs.product_name }}" \
          --subtitle="${{ github.event.inputs.document_type }}" \
          --version="${{ github.event.inputs.version }}" \
          --lang="${LANG_DISPLAY}" \
          --number="${{ github.event.inputs.document_number }}" \
          --output="./pdf/front-cover.html"
        
        # í”„ë¡ íŠ¸ ì»¤ë²„ HTMLì„ PDFë¡œ ë³€í™˜
        prince "./pdf/front-cover.html" -o "./pdf/front-cover.pdf"
        
        # ë©”ì¸ ë¬¸ì„œ PDF ìƒì„±
        echo "ðŸ“– ë©”ì¸ ë¬¸ì„œ PDF ìƒì„± ì¤‘..."
        node generatepdf \
          -u "${{ github.event.inputs.target_url }}" \
          --prince-args="--page-size='a4' --style=./print.css --javascript" \
          -o "./pdf/${MAIN_PDF_NAME}" \
          --dest ./pdf \
          --include-index
        
        # ë³‘ë ¬ë¡œ ì£¼ì„ ì œê±° (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
        echo "ðŸ”§ PDF ì£¼ì„ ì œê±° ì¤‘..."
        pdfcpu annot remove "./pdf/front-cover.pdf" &
        FRONT_PID=$!
        
        if [ -f "./pdf/${MAIN_PDF_NAME}" ]; then
          pdfcpu annot remove -pages 1 "./pdf/${MAIN_PDF_NAME}" &
          MAIN_PID=$!
        else
          echo "âŒ ì˜¤ë¥˜: ë©”ì¸ PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${MAIN_PDF_NAME}"
          exit 1
        fi
        
        # ì£¼ì„ ì œê±° ì™„ë£Œ ëŒ€ê¸°
        wait $FRONT_PID $MAIN_PID
        echo "âœ… ëª¨ë“  PDF ì£¼ì„ ì œê±° ì™„ë£Œ"

    - name: Merge PDFs and configure viewer settings
      run: |
        echo "ðŸ“‘ PDF íŒŒì¼ ë³‘í•© ë° ë·°ì–´ ì„¤ì • ì¤‘..."
        
        # í•„ìš”í•œ íŒŒì¼ë“¤ ì¡´ìž¬ í™•ì¸
        REQUIRED_FILES=("./pdf/front-cover.pdf" "./pdf/${MAIN_PDF_NAME}" "${BACK_COVER}")
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ì˜¤ë¥˜: í•„ìš”í•œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $file"
            exit 1
          fi
        done
        
        # PDFtkë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶ë§ˆí¬ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ë³‘í•©
        echo "ðŸ“Ž PDFtkë¡œ PDF ë³‘í•© ì¤‘ (ë¶ë§ˆí¬ ë³´ì¡´)..."
        pdftk "./pdf/front-cover.pdf" "./pdf/${MAIN_PDF_NAME}" "${BACK_COVER}" cat output "./pdf/${FINAL_PDF_NAME}"
        
        # ë³‘í•©ëœ íŒŒì¼ ì¡´ìž¬ í™•ì¸
        if [ ! -f "./pdf/${FINAL_PDF_NAME}" ]; then
          echo "âŒ ì˜¤ë¥˜: PDF ë³‘í•© ì‹¤íŒ¨ - íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        # ë·°ì–´ ì„¤ì •ì„ ìˆœì°¨ì ìœ¼ë¡œ ì ìš© (íŒŒì¼ ì¶©ëŒ ë°©ì§€)
        echo "âš™ï¸ PDF ë·°ì–´ ì„¤ì • ì ìš© ì¤‘..."
        
        echo "ðŸ“– ì±…ê°ˆí”¼ íŒ¨ë„ í‘œì‹œ ì„¤ì •..."
        pdfcpu pagemode set "./pdf/${FINAL_PDF_NAME}" UseOutlines
        
        echo "ðŸ“„ í•œ íŽ˜ì´ì§€ ë ˆì´ì•„ì›ƒ ì„¤ì •..."
        pdfcpu pagelayout set "./pdf/${FINAL_PDF_NAME}" SinglePage
        
        echo "ðŸ” ë·°ì–´ í™˜ê²½ì„¤ì • ì ìš©..."
        pdfcpu viewerpref set "./pdf/${FINAL_PDF_NAME}" '{"FitWindow": true, "CenterWindow": true}'
        
        echo "âœ… PDF ë³‘í•© ë° ë·°ì–´ ì„¤ì • ì™„ë£Œ:"
        echo "  ðŸ“Ž íŒŒì¼: ./pdf/${FINAL_PDF_NAME}"
        echo "  ðŸ“– íŽ˜ì´ì§€ ëª¨ë“œ: UseOutlines (ì±…ê°ˆí”¼ íŒ¨ë„)"
        echo "  ðŸ“„ ë ˆì´ì•„ì›ƒ: SinglePage"
        echo "  ðŸ” ë·°ì–´ ì„¤ì •: FitWindow, CenterWindow"

    - name: Check and prepare release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ—‘ï¸ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ë° íƒœê·¸ ì •ë¦¬ ì¤‘: ${RELEASE_NAME}"
        
        # ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì‹œë„ (ìµœëŒ€ 3íšŒ ìž¬ì‹œë„)
        for i in {1..3}; do
          if gh release delete "${RELEASE_NAME}" -y 2>/dev/null; then
            echo "âœ… ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì™„ë£Œ (ì‹œë„ $i/3)"
            break
          else
            if [ $i -eq 3 ]; then
              echo "â„¹ï¸ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì—†ìŒ ë˜ëŠ” ì‚­ì œ ì‹¤íŒ¨ (ìµœì¢…)"
            else
              echo "â³ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ìž¬ì‹œë„ ì¤‘... ($i/3)"
              sleep 2
            fi
          fi
        done
        
        # ê¸°ì¡´ íƒœê·¸ ì‚­ì œ ì‹œë„
        git push origin --delete "${RELEASE_NAME}" 2>/dev/null || echo "â„¹ï¸ ê¸°ì¡´ íƒœê·¸ ì—†ìŒ ë˜ëŠ” ì‚­ì œ ì‹¤íŒ¨"
        
        echo "âœ… ë¦´ë¦¬ìŠ¤ ì¤€ë¹„ ì™„ë£Œ"

    - name: Create GitHub Release and Upload PDF
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ†• ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ ìƒì„± ë° PDF ì—…ë¡œë“œ ì¤‘..."
        
        # ìµœì¢… PDF íŒŒì¼ ì¡´ìž¬ ë° í¬ê¸° í™•ì¸
        if [ ! -f "./pdf/${FINAL_PDF_NAME}" ]; then
          echo "âŒ ì˜¤ë¥˜: ì—…ë¡œë“œí•  PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${FINAL_PDF_NAME}"
          exit 1
        fi
        
        FILE_SIZE=$(ls -lh "./pdf/${FINAL_PDF_NAME}" | awk '{print $5}')
        echo "ðŸ“Š PDF íŒŒì¼ í¬ê¸°: ${FILE_SIZE}"
        
        # íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ ìž‘ìœ¼ë©´ ê²½ê³  (1MB ë¯¸ë§Œ)
        FILE_SIZE_BYTES=$(stat -c%s "./pdf/${FINAL_PDF_NAME}" 2>/dev/null || stat -f%z "./pdf/${FINAL_PDF_NAME}")
        if [ "${FILE_SIZE_BYTES}" -lt 1048576 ]; then
          echo "âš ï¸ ê²½ê³ : PDF íŒŒì¼ í¬ê¸°ê°€ ìž‘ìŠµë‹ˆë‹¤ (${FILE_SIZE}). ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
        fi
        
        # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìž‘ì„± (ë” ìƒì„¸í•œ ì •ë³´ í¬í•¨)
        cat > release_notes.md << EOF
        # ${{ github.event.inputs.product_name }} ${{ github.event.inputs.document_type }}

        **ë²„ì „:** ${{ github.event.inputs.version }}
        **ë¬¸ì„œ ë²ˆí˜¸:** ${{ github.event.inputs.document_number }}
        **ë¦´ë¦¬ìŠ¤ ë‚ ì§œ:** ${{ github.event.inputs.release_date }}
        **ì–¸ì–´:** ${LANG_DISPLAY}
        **ì†ŒìŠ¤ URL:** ${{ github.event.inputs.target_url }}
        **íŒŒì¼ í¬ê¸°:** ${FILE_SIZE}
        **ìƒì„± ì¼ì‹œ:** $(date '+%Y-%m-%d %H:%M:%S UTC')

        ## ðŸ“¥ ë‹¤ìš´ë¡œë“œ
        - [${FINAL_PDF_NAME}](https://github.com/${{ github.repository }}/releases/download/${RELEASE_NAME}/${FINAL_PDF_NAME})

        ## ðŸ”§ ê¸°ìˆ  ì •ë³´
        - PDF ë·°ì–´ ì„¤ì •: ì±…ê°ˆí”¼ íŒ¨ë„ í‘œì‹œ, í•œ íŽ˜ì´ì§€ ë ˆì´ì•„ì›ƒ
        - ë¶ë§ˆí¬: ë³´ì¡´ë¨
        - íŽ˜ì´ì§€ í¬ê¸°: A4
        EOF
        
        echo "ðŸ“Œ íƒœê·¸ëª…: ${RELEASE_NAME}"
        echo "ðŸ“ ë¦´ë¦¬ìŠ¤ ì œëª©: ${RELEASE_TITLE}"
        
        # ë¦´ë¦¬ìŠ¤ ìƒì„± ìž¬ì‹œë„ ë¡œì§
        for i in {1..3}; do
          if gh release create "${RELEASE_NAME}" \
            --title "${RELEASE_TITLE}" \
            --notes-file release_notes.md \
            "./pdf/${FINAL_PDF_NAME}"; then
            echo "âœ… ë¦´ë¦¬ìŠ¤ ìƒì„± ë° PDF ì—…ë¡œë“œ ì™„ë£Œ (ì‹œë„ $i/3)"
            break
          else
            if [ $i -eq 3 ]; then
              echo "âŒ ë¦´ë¦¬ìŠ¤ ìƒì„± ì‹¤íŒ¨ (ìµœì¢… ì‹œë„)"
              exit 1
            else
              echo "â³ ë¦´ë¦¬ìŠ¤ ìƒì„± ìž¬ì‹œë„ ì¤‘... ($i/3)"
              sleep 5
            fi
          fi
        done

    - name: Show completion summary
      run: |
        echo "ðŸŽ‰ PDF ìƒì„± ë° ë¦´ë¦¬ìŠ¤ ì™„ë£Œ!"
        echo "=========================="
        echo "ðŸ“ ìƒì„±ëœ íŒŒì¼:"
        ls -la ./pdf/ | grep -E '\.(pdf|html)$' || echo "PDF íŒŒì¼ ì—†ìŒ"
        echo "=========================="
        echo "ðŸ”— ë¦´ë¦¬ìŠ¤: https://github.com/${{ github.repository }}/releases/tag/${RELEASE_NAME}"
        echo "ðŸ“ ë¦´ë¦¬ìŠ¤ ì œëª©: ${RELEASE_TITLE}"
        echo "ðŸ·ï¸ íƒœê·¸ëª…: ${RELEASE_NAME}"
        echo "ðŸ“„ ì—…ë¡œë“œëœ íŒŒì¼: ${FINAL_PDF_NAME}"
        echo "ðŸŒ ì–¸ì–´: ${{ github.event.inputs.language }}"
        echo "ðŸ“Š íŒŒì¼ í¬ê¸°:"
        if [ -f "./pdf/${FINAL_PDF_NAME}" ]; then
          ls -lh "./pdf/${FINAL_PDF_NAME}" | awk '{print "  " $5 " - " $9}'
        else
          echo "  íŒŒì¼ í¬ê¸° í™•ì¸ ë¶ˆê°€"
        fi
