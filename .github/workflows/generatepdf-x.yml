name: Generate PDF-BioStarX Administrator Guide

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ë¬¸ì„œ ë²„ì „"
        required: true
        default: "1.0.0"
      document_number:
        description: "ë¬¸ì„œ ë²ˆí˜¸ (ì˜ˆ: 102.00.BSX)"
        required: true
        default: "102.00.BSX"
      release_date:
        description: "ë¦´ë¦¬ìŠ¤ ë‚ ì§œ (YYMMDD í˜•ì‹)"
        required: true
        default: "YYMMDD"

permissions:
  contents: write

env:
  PRINCE_VER: 16
  PRODUCT_NAME: "BioStar X"
  DOC_TYPE: "Administrator Guide"
  BASE_URL_KO: "https://docs.supremainc.com/platform/biostar_x"
  BASE_URL_EN: "https://docs.supremainc.com/en/platform/biostar_x"

jobs:
  generate-pdf:
    name: Generate BioStar X Administrator Guide PDF
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate inputs
      run: |
        echo "ðŸ” ìž…ë ¥ê°’ ê²€ì¦ ì¤‘..."
        
        # ë‚ ì§œ í˜•ì‹ ê²€ì¦ (YYMMDD)
        if ! echo "${{ github.event.inputs.release_date }}" | grep -qE '^[0-9]{6}$'; then
          echo "âŒ ì˜¤ë¥˜: ë¦´ë¦¬ìŠ¤ ë‚ ì§œëŠ” YYMMDD í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤: ${{ github.event.inputs.release_date }}"
          exit 1
        fi
        
        echo "âœ… ëª¨ë“  ìž…ë ¥ê°’ì´ ìœ íš¨í•©ë‹ˆë‹¤"

    - name: Print workflow inputs
      run: |
        echo "=== ì›Œí¬í”Œë¡œìš° ìž…ë ¥ê°’ ==="
        echo "ì œí’ˆëª…: ${PRODUCT_NAME}"
        echo "ë¬¸ì„œ ìœ í˜•: ${DOC_TYPE}"
        echo "ë²„ì „: ${{ github.event.inputs.version }}"
        echo "ë¬¸ì„œ ë²ˆí˜¸: ${{ github.event.inputs.document_number }}"
        echo "ë¦´ë¦¬ìŠ¤ ë‚ ì§œ: ${{ github.event.inputs.release_date }}"
        echo ""
        echo "=== PDF ìƒì„± URL ==="
        echo "í•œêµ­ì–´: ${BASE_URL_KO}"
        echo "ì˜ì–´: ${BASE_URL_EN}"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Install Prince XML
      run: |
        echo "ðŸ“¦ Prince XML ì„¤ì¹˜ ì¤‘..."
        curl https://www.princexml.com/download/prince-${{ env.PRINCE_VER }}-macos.zip -O
        tar zxf prince-${{ env.PRINCE_VER }}-macos.zip
        cd prince-${{ env.PRINCE_VER }}-macos
        yes "" | sudo ./install.sh
        echo "âœ… Prince XML ì„¤ì¹˜ ì™„ë£Œ"

    - name: Install other tools
      run: |
        echo "ðŸ“¦ ê¸°íƒ€ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."
        echo "ðŸ”„ Homebrew ì—…ë°ì´íŠ¸ ì¤‘..."
        brew update
        echo "ðŸ“¦ ë„êµ¬ ì„¤ì¹˜ ì¤‘: pdfcpu, pdftk-java, gh"
        brew install pdfcpu pdftk-java gh
        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"

    - name: Setup environment variables
      run: |
        echo "ðŸ“Š í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
        
        # íŒŒì¼ëª…ìš© ì•ˆì „í•œ ë¬¸ìžì—´ ìƒì„±
        PRODUCT_SAFE="BioStarX"
        DOC_TYPE_SAFE="Administrator_Guide"
        
        # ë¦´ë¦¬ìŠ¤ëª… ë° íƒœê·¸ ì„¤ì •
        RELEASE_NAME="${PRODUCT_SAFE}-${DOC_TYPE_SAFE}-v${{ github.event.inputs.version }}"
        RELEASE_TITLE="BioStar X Administrator Guide v${{ github.event.inputs.version }}"
        
        # PDF íŒŒì¼ëª… ì„¤ì • (í•œêµ­ì–´/ì˜ì–´)
        PDF_NAME_KO="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_KO_${{ github.event.inputs.release_date }}.pdf"
        PDF_NAME_EN="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_EN_${{ github.event.inputs.release_date }}.pdf"
        FINAL_PDF_NAME_KO="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_KO_${{ github.event.inputs.release_date }}_Final.pdf"
        FINAL_PDF_NAME_EN="${PRODUCT_SAFE}_${DOC_TYPE_SAFE}_${{ github.event.inputs.version }}_EN_${{ github.event.inputs.release_date }}_Final.pdf"
        
        # í™˜ê²½ë³€ìˆ˜ë¡œ ì €ìž¥
        echo "PRODUCT_SAFE=${PRODUCT_SAFE}" >> $GITHUB_ENV
        echo "DOC_TYPE_SAFE=${DOC_TYPE_SAFE}" >> $GITHUB_ENV
        echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_ENV
        echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_ENV
        echo "PDF_NAME_KO=${PDF_NAME_KO}" >> $GITHUB_ENV
        echo "PDF_NAME_EN=${PDF_NAME_EN}" >> $GITHUB_ENV
        echo "FINAL_PDF_NAME_KO=${FINAL_PDF_NAME_KO}" >> $GITHUB_ENV
        echo "FINAL_PDF_NAME_EN=${FINAL_PDF_NAME_EN}" >> $GITHUB_ENV
        
        echo "âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ:"
        echo "  ðŸ·ï¸ íƒœê·¸ëª…: ${RELEASE_NAME}"
        echo "  ðŸ“ ë¦´ë¦¬ìŠ¤ ì œëª©: ${RELEASE_TITLE}"
        echo "  ðŸ“„ í•œêµ­ì–´ PDF: ${FINAL_PDF_NAME_KO}"
        echo "  ðŸ“„ ì˜ì–´ PDF: ${FINAL_PDF_NAME_EN}"

    - name: Create PDF output directory
      run: mkdir -p ./pdf

    - name: Generate Korean PDFs
      run: |
        echo "ðŸ“„ í•œêµ­ì–´ PDF ìƒì„± ì‹œìž‘..."
        
        # í•œêµ­ì–´ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„±
        echo "ðŸ“„ í•œêµ­ì–´ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì¤‘..."
        node generate-cover-local.js \
          --title="${PRODUCT_NAME}" \
          --subtitle="${DOC_TYPE}" \
          --version="${{ github.event.inputs.version }}" \
          --lang="í•œêµ­ì–´" \
          --number="${{ github.event.inputs.document_number }}" \
          --output="./pdf/front-cover-ko.html"
        
        # í”„ë¡ íŠ¸ ì»¤ë²„ HTMLì„ PDFë¡œ ë³€í™˜
        prince "./pdf/front-cover-ko.html" -o "./pdf/front-cover-ko.pdf"
        
        # í•œêµ­ì–´ ë©”ì¸ ë¬¸ì„œ PDF ìƒì„±
        echo "ðŸ“– í•œêµ­ì–´ ë©”ì¸ ë¬¸ì„œ PDF ìƒì„± ì¤‘..."
        node generatepdf \
          -u "${BASE_URL_KO}" \
          --prince-args="--page-size='a4' --style=./print.css --javascript" \
          -o "./pdf/${PDF_NAME_KO}" \
          --dest ./pdf \
          --include-index
        
        echo "âœ… í•œêµ­ì–´ PDF ìƒì„± ì™„ë£Œ"

    - name: Generate English PDFs
      run: |
        echo "ðŸ“„ ì˜ì–´ PDF ìƒì„± ì‹œìž‘..."
        
        # ì˜ì–´ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„±
        echo "ðŸ“„ ì˜ì–´ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì¤‘..."
        node generate-cover-local.js \
          --title="${PRODUCT_NAME}" \
          --subtitle="${DOC_TYPE}" \
          --version="${{ github.event.inputs.version }}" \
          --lang="English" \
          --number="${{ github.event.inputs.document_number }}" \
          --output="./pdf/front-cover-en.html"
        
        # í”„ë¡ íŠ¸ ì»¤ë²„ HTMLì„ PDFë¡œ ë³€í™˜
        prince "./pdf/front-cover-en.html" -o "./pdf/front-cover-en.pdf"
        
        # ì˜ì–´ ë©”ì¸ ë¬¸ì„œ PDF ìƒì„±
        echo "ðŸ“– ì˜ì–´ ë©”ì¸ ë¬¸ì„œ PDF ìƒì„± ì¤‘..."
        node generatepdf \
          -u "${BASE_URL_EN}" \
          --prince-args="--page-size='a4' --style=./print.css --javascript" \
          -o "./pdf/${PDF_NAME_EN}" \
          --dest ./pdf \
          --include-index
        
        echo "âœ… ì˜ì–´ PDF ìƒì„± ì™„ë£Œ"

    - name: Process Korean PDFs
      run: |
        echo "ðŸ”§ í•œêµ­ì–´ PDF ì²˜ë¦¬ ì¤‘..."
        
        # ì£¼ì„ ì œê±°
        pdfcpu annot remove "./pdf/front-cover-ko.pdf"
        
        if [ -f "./pdf/${PDF_NAME_KO}" ]; then
          pdfcpu annot remove -pages 1 "./pdf/${PDF_NAME_KO}"
        else
          echo "âŒ ì˜¤ë¥˜: í•œêµ­ì–´ ë©”ì¸ PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        # PDF ë³‘í•©
        echo "ðŸ“Ž í•œêµ­ì–´ PDF ë³‘í•© ì¤‘..."
        pdftk "./pdf/front-cover-ko.pdf" "./pdf/${PDF_NAME_KO}" "back-cover.pdf" cat output "./pdf/${FINAL_PDF_NAME_KO}"
        
        # ë·°ì–´ ì„¤ì • ì ìš©
        echo "âš™ï¸ í•œêµ­ì–´ PDF ë·°ì–´ ì„¤ì • ì ìš©..."
        pdfcpu pagemode set "./pdf/${FINAL_PDF_NAME_KO}" UseOutlines
        pdfcpu pagelayout set "./pdf/${FINAL_PDF_NAME_KO}" SinglePage
        pdfcpu viewerpref set "./pdf/${FINAL_PDF_NAME_KO}" '{"FitWindow": true, "CenterWindow": true}'
        
        echo "âœ… í•œêµ­ì–´ PDF ì²˜ë¦¬ ì™„ë£Œ"

    - name: Process English PDFs
      run: |
        echo "ðŸ”§ ì˜ì–´ PDF ì²˜ë¦¬ ì¤‘..."
        
        # ì£¼ì„ ì œê±°
        pdfcpu annot remove "./pdf/front-cover-en.pdf"
        
        if [ -f "./pdf/${PDF_NAME_EN}" ]; then
          pdfcpu annot remove -pages 1 "./pdf/${PDF_NAME_EN}"
        else
          echo "âŒ ì˜¤ë¥˜: ì˜ì–´ ë©”ì¸ PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        # PDF ë³‘í•©
        echo "ðŸ“Ž ì˜ì–´ PDF ë³‘í•© ì¤‘..."
        pdftk "./pdf/front-cover-en.pdf" "./pdf/${PDF_NAME_EN}" "back-cover-en.pdf" cat output "./pdf/${FINAL_PDF_NAME_EN}"
        
        # ë·°ì–´ ì„¤ì • ì ìš©
        echo "âš™ï¸ ì˜ì–´ PDF ë·°ì–´ ì„¤ì • ì ìš©..."
        pdfcpu pagemode set "./pdf/${FINAL_PDF_NAME_EN}" UseOutlines
        pdfcpu pagelayout set "./pdf/${FINAL_PDF_NAME_EN}" SinglePage
        pdfcpu viewerpref set "./pdf/${FINAL_PDF_NAME_EN}" '{"FitWindow": true, "CenterWindow": true}'
        
        echo "âœ… ì˜ì–´ PDF ì²˜ë¦¬ ì™„ë£Œ"

    - name: Check and prepare release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ—‘ï¸ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ë° íƒœê·¸ ì •ë¦¬ ì¤‘: ${RELEASE_NAME}"
        
        # ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì‹œë„ (ìµœëŒ€ 3íšŒ ìž¬ì‹œë„)
        for i in {1..3}; do
          if gh release delete "${RELEASE_NAME}" -y 2>/dev/null; then
            echo "âœ… ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì™„ë£Œ (ì‹œë„ $i/3)"
            break
          else
            if [ $i -eq 3 ]; then
              echo "â„¹ï¸ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì—†ìŒ ë˜ëŠ” ì‚­ì œ ì‹¤íŒ¨ (ìµœì¢…)"
            else
              echo "â³ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ìž¬ì‹œë„ ì¤‘... ($i/3)"
              sleep 2
            fi
          fi
        done
        
        # ê¸°ì¡´ íƒœê·¸ ì‚­ì œ ì‹œë„
        git push origin --delete "${RELEASE_NAME}" 2>/dev/null || echo "â„¹ï¸ ê¸°ì¡´ íƒœê·¸ ì—†ìŒ ë˜ëŠ” ì‚­ì œ ì‹¤íŒ¨"
        
        echo "âœ… ë¦´ë¦¬ìŠ¤ ì¤€ë¹„ ì™„ë£Œ"

    - name: Create GitHub Release and Upload PDFs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ†• ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ ìƒì„± ë° PDF ì—…ë¡œë“œ ì¤‘..."
        
        # PDF íŒŒì¼ ì¡´ìž¬ ë° í¬ê¸° í™•ì¸
        for PDF_FILE in "${FINAL_PDF_NAME_KO}" "${FINAL_PDF_NAME_EN}"; do
          if [ ! -f "./pdf/${PDF_FILE}" ]; then
            echo "âŒ ì˜¤ë¥˜: PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${PDF_FILE}"
            exit 1
          fi
          FILE_SIZE=$(ls -lh "./pdf/${PDF_FILE}" | awk '{print $5}')
          echo "ðŸ“Š ${PDF_FILE} í¬ê¸°: ${FILE_SIZE}"
        done
        
        # Release Notes
        cat > release_notes.md << EOF
        # BioStar X Administrator Guide

        **Version:** ${{ github.event.inputs.version }}
        **Document number:** ${{ github.event.inputs.document_number }}
        **Release date:** ${{ github.event.inputs.release_date }}
        **Create date:** $(date '+%Y-%m-%d %H:%M:%S UTC')

        ## ðŸ“¥ Downloads
        - í•œêµ­ì–´: [${FINAL_PDF_NAME_KO}](https://github.com/${{ github.repository }}/releases/download/${RELEASE_NAME}/${FINAL_PDF_NAME_KO})
        - English: [${FINAL_PDF_NAME_EN}](https://github.com/${{ github.repository }}/releases/download/${RELEASE_NAME}/${FINAL_PDF_NAME_EN})

        ## ðŸ“„ Source URLs
        - í•œêµ­ì–´: ${BASE_URL_KO}
        - English: ${BASE_URL_EN}
        EOF
        
        echo "ðŸ“Œ íƒœê·¸ëª…: ${RELEASE_NAME}"
        echo "ðŸ“ ë¦´ë¦¬ìŠ¤ ì œëª©: ${RELEASE_TITLE}"
        
        # ë¦´ë¦¬ìŠ¤ ìƒì„± ë° PDF ì—…ë¡œë“œ (ìž¬ì‹œë„ ë¡œì§)
        for i in {1..3}; do
          if gh release create "${RELEASE_NAME}" \
            --title "${RELEASE_TITLE}" \
            --notes-file release_notes.md \
            "./pdf/${FINAL_PDF_NAME_KO}" \
            "./pdf/${FINAL_PDF_NAME_EN}"; then
            echo "âœ… ë¦´ë¦¬ìŠ¤ ìƒì„± ë° PDF ì—…ë¡œë“œ ì™„ë£Œ (ì‹œë„ $i/3)"
            break
          else
            if [ $i -eq 3 ]; then
              echo "âŒ ë¦´ë¦¬ìŠ¤ ìƒì„± ì‹¤íŒ¨ (ìµœì¢… ì‹œë„)"
              exit 1
            else
              echo "â³ ë¦´ë¦¬ìŠ¤ ìƒì„± ìž¬ì‹œë„ ì¤‘... ($i/3)"
              sleep 5
            fi
          fi
        done

    - name: Show completion summary
      run: |
        echo "ðŸŽ‰ PDF ìƒì„± ë° ë¦´ë¦¬ìŠ¤ ì™„ë£Œ!"
        echo "=========================="
        echo "ðŸ“ ìƒì„±ëœ íŒŒì¼:"
        ls -lh ./pdf/ | grep -E '\.pdf$' || echo "PDF íŒŒì¼ ì—†ìŒ"
        echo "=========================="
        echo "ðŸ”— ë¦´ë¦¬ìŠ¤: https://github.com/${{ github.repository }}/releases/tag/${RELEASE_NAME}"
        echo "ðŸ“ ë¦´ë¦¬ìŠ¤ ì œëª©: ${RELEASE_TITLE}"
        echo "ðŸ·ï¸ íƒœê·¸ëª…: ${RELEASE_NAME}"
        echo "ðŸ“„ í•œêµ­ì–´ PDF: ${FINAL_PDF_NAME_KO}"
        echo "ðŸ“„ ì˜ì–´ PDF: ${FINAL_PDF_NAME_EN}"